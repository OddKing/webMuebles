{% extends 'admin_panel/base.html' %}

{% block title %}Historial de Cotizaciones - Admin Panel{% endblock %}
{% block page_title %}Historial de Cotizaciones{% endblock %}

{% block content %}
<!-- Filtros y Búsqueda -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card bg-dark text-light">
            <div class="card-body">
                <form method="GET" class="row g-3">
                    <div class="col-md-9">
                        <label class="form-label">Buscar</label>
                        <input type="text" name="q" class="form-control" placeholder="Folio, nombre, email..." value="{{ search_query }}">
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <a href="{% url 'admin_crear_cotizacion' %}" class="btn btn-success w-100"><i class="bi bi-plus"></i> Nueva Cotización</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Estadísticas -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card bg-dark text-light">
            <div class="card-body text-center">
                <h5 class="text-muted">Total</h5>
                <h2>{{ total_cotizaciones }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-dark text-light">
            <div class="card-body text-center">
                <h5 class="text-muted">Aprobadas</h5>
                <h2 class="text-success">{{ total_aprobadas }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-dark text-light">
            <div class="card-body text-center">
                <h5 class="text-muted">Pendientes</h5>
                <h2 class="text-warning">{{ total_pendientes }}</h2>
            </div>
        </div>
    </div>
</div>

<!-- Tabla -->
<div class="card bg-dark text-light">
    <div class="card-header bg-dark">
        <h5 class="mb-0"><i class="bi bi-clock-history"></i> Cotizaciones ({{ cotizaciones.count }})</h5>
    </div>
    <div class="card-body">
        {% if cotizaciones %}
        <div class="table-responsive">
            <table class="table table-dark table-hover">
                <thead>
                    <tr>
                        <th>Folio</th>
                        <th>Cliente</th>
                        <th>Producto</th>
                        <th>Precio</th>
                        <th>Estado</th>
                        <th>Fecha</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for cot in cotizaciones %}
                    <tr>
                        <td><strong>{{ cot.folio }}</strong></td>
                        <td>
                            {{ cot.nombre_completo }}
                            {% if cot.cliente %}
                            <br><small class="text-muted"><i class="bi bi-person-check"></i> Cliente Habitual</small>
                            {% endif %}
                        </td>
                        <td>{{ cot.producto.nombre|default:"Personalizado" }}</td>
                        <td>
                            {% if cot.precio_cotizado %}
                            ${{ cot.precio_cotizado|floatformat:0 }}
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if cot.estado == 'pendiente_aprobacion' %}
                            <span class="badge bg-warning">Pendiente</span>
                            {% elif cot.estado == 'aprobada' %}
                            <span class="badge bg-success">Aprobada</span>
                            {% elif cot.estado == 'rechazada' %}
                            <span class="badge bg-danger">Rechazada</span>
                            {% else %}
                            <span class="badge bg-info">{{ cot.get_estado_display }}</span>
                            {% endif %}
                        </td>
                        <td>{{ cot.fecha_solicitud|date:"d/m/Y" }}</td>
                        <td class="text-center">
                            <div class="btn-group">
                                <a href="{% url 'admin_cotizacion_detalle' cot.id %}" class="btn btn-sm btn-admin-secondary"><i class="bi bi-eye"></i></a>
                                <a href="{% url 'admin_editar_cotizacion' cot.id %}" class="btn btn-sm btn-admin-primary"><i class="bi bi-pencil"></i></a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info text-center">
            No se encontraron cotizaciones.
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}