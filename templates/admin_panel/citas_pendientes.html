{% extends 'admin_panel/base.html' %}

{% block page_title %}Citas Pendientes{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-calendar-check"></i> Citas Pendientes de Aprobación</span>
        <span class="badge bg-warning text-dark">{{ citas.count }} pendientes</span>
    </div>
    <div class="card-body">
        {% if citas %}
        <div class="table-responsive">
            <table class="table table-dark">
                <thead>
                    <tr>
                        <th>Cliente</th>
                        <th>Email</th>
                        <th>Teléfono</th>
                        <th>Fecha</th>
                        <th>Hora</th>
                        <th>Tipo</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for cita in citas %}
                    <tr>
                        <td><strong style="color: var(--admin-secondary);">{{ cita.nombre_completo }}</strong></td>
                        <td>{{ cita.email }}</td>
                        <td>{{ cita.telefono }}</td>
                        <td>{{ cita.fecha|date:"d/m/Y" }}</td>
                        <td>{{ cita.hora|time:"H:i" }}</td>
                        <td>
                            {% if cita.tipo_reunion == 'online' %}
                                <span class="badge bg-info"><i class="bi bi-camera-video"></i> Online</span>
                            {% else %}
                                <span class="badge bg-primary"><i class="bi bi-geo-alt"></i> Presencial</span>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-admin-primary" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#detailModal{{ cita.id }}">
                                <i class="bi bi-eye"></i> Ver
                            </button>
                        </td>
                    </tr>
                    
                    <!-- Modal de Detalles -->
                    <div class="modal fade" id="detailModal{{ cita.id }}" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content bg-dark text-light">
                                <div class="modal-header" style="border-color: var(--admin-primary);">
                                    <h5 class="modal-title" style="color: var(--admin-secondary);">
                                        Detalle de Cita - {{ cita.nombre_completo }}
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6 style="color: var(--admin-secondary);">Información del Cliente</h6>
                                            <p><strong>Nombre Completo:</strong> {{ cita.nombre_completo }}</p>
                                            <p><strong>Email:</strong> {{ cita.email }}</p>
                                            <p><strong>Teléfono:</strong> {{ cita.telefono }}</p>
                                            <p><strong>Dirección:</strong> {{ cita.direccion }}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <h6 style="color: var(--admin-secondary);">Detalles de la Reunión</h6>
                                            <p><strong>Tipo de Reunión:</strong> {{ cita.get_tipo_reunion_display }}</p>
                                            <p><strong>Fecha:</strong> {{ cita.fecha|date:"d \\d\\e F \\d\\e Y" }}</p>
                                            <p><strong>Hora:</strong> {{ cita.hora|time:"H:i" }} hrs</p>
                                            <p><strong>Estado:</strong> {{ cita.get_estado_display }}</p>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-3">
                                        <h6 style="color: var(--admin-secondary);">Información Adicional</h6>
                                        <p><strong>Fecha de Creación:</strong> {{ cita.fecha_creacion|date:"d/m/Y H:i" }}</p>
                                        {% if cita.tipo_reunion == 'presencial' %}
                                        <div class="alert alert-info">
                                            <i class="bi bi-info-circle"></i> <strong>Reunión Presencial</strong><br>
                                            Ubicación: Av Lo Espejo 964, El Bosque, Santiago
                                        </div>
                                        {% else %}
                                        <div class="alert alert-info">
                                            <i class="bi bi-camera-video"></i> <strong>Reunión Online</strong><br>
                                            Se enviará el enlace de la videollamada al aprobar la cita.
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="modal-footer" style="border-color: var(--admin-primary);">
                                    <form method="post" action="{% url 'rechazar_cita' cita.id %}" class="d-inline">
                                        {% csrf_token %}
                                        <div class="mb-3">
                                            <label for="admin_notas{{ cita.id }}" class="form-label">Motivo de Rechazo (opcional)</label>
                                            <textarea class="form-control bg-dark text-light" 
                                                      id="admin_notas{{ cita.id }}" 
                                                      name="admin_notas" 
                                                      rows="2"
                                                      placeholder="Ejemplo: Horario no disponible, fecha no disponible, etc."></textarea>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" 
                                                   type="checkbox" 
                                                   id="enviar_email{{ cita.id }}" 
                                                   name="enviar_email" 
                                                   value="si">
                                            <label class="form-check-label" for="enviar_email{{ cita.id }}">
                                                Enviar email de notificación al cliente
                                            </label>
                                        </div>
                                        <button type="submit" class="btn btn-danger">
                                            <i class="bi bi-x-circle"></i> Rechazar
                                        </button>
                                    </form>
                                    
                                    <form method="post" action="{% url 'aprobar_cita' cita.id %}" class="d-inline">
                                        {% csrf_token %}
                                        {% if cita.tipo_reunion == 'online' %}
                                        <div class="mb-3 text-start">
                                            <label for="meeting_link{{ cita.id }}" class="form-label text-warning">
                                                <i class="bi bi-link-45deg"></i> Link de Google Meet (Requerido)
                                            </label>
                                            <input type="url" class="form-control bg-dark text-light" 
                                                   id="meeting_link{{ cita.id }}" 
                                                   name="meeting_link" 
                                                   placeholder="https://meet.google.com/..."
                                                   required>
                                            <div class="form-text text-muted">Pega aquí el link de la reunión que creaste.</div>
                                        </div>
                                        {% endif %}
                                        <button type="submit" class="btn btn-success">
                                            <i class="bi bi-check-circle"></i> Aprobar y Enviar Confirmación
                                        </button>
                                    </form>
                                    
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                        Cerrar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-inbox" style="font-size: 4rem; color: #666;"></i>
            <p class="text-muted mt-3">No hay citas pendientes de aprobación</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .modal-content {
        background-color: #2a2a2a !important;
        border: 2px solid var(--admin-primary);
    }
    
    .form-control {
        background-color: #0d0d0d;
        border: 1px solid rgba(139, 69, 19, 0.3);
        color: #e0e0e0;
    }
    
    .form-control:focus {
        background-color: #0d0d0d;
        border-color: var(--admin-primary);
        color: #e0e0e0;
    }
    
    .alert-info {
        background-color: rgba(13, 202, 240, 0.2);
        border-left: 3px solid #0dcaf0;
        color: #9eeaf9;
    }
</style>
{% endblock %}
